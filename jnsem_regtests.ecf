#!/bin/bash --login

# Contributors: Andre van der Westhuysen
#
# ----------------------------------------------------------- 
# ------------- Program Description and Details ------------- 
# ----------------------------------------------------------- 
#
# Job Card to set the resources required for a NSEM run
#
# ----------------------------------------------------------- 

#SBATCH --account=coastal
#SBATCH --job-name=jnsem_regt
#SBATCH -q debug
#SBATCH --time=00:30:00
#SBATCH --ntasks=12
##SBATCH --ntasks=23
##SBATCH --ntasks=1440
##SBATCH --ntasks=720
##SBATCH --ntasks=385
##SBATCH --nodes=120
##SBATCH --nodes=60
#SBATCH --mem 3000
#SBATCH --cpus-per-task=1            # Number of cores per MPI rank (for hyperthreading)
##SBATCH --nodes=121                  # Number of nodes
##SBATCH --ntasks-per-node=12         # How many tasks on each node
#SBATCH --mail-user=andre.vanderwesthuysen@noaa.gov
#SBATCH --mail-type=ALL
#SBATCH --output=jnsem_forecast.out.log
#SBATCH --error=jnsem_forecast.err.log

export WORKdir=/scratch2/COASTAL/coastal/noscrub/shared/Saeed.Moghimi/coastalapp_test/rerun-andre/CoastalApp-WW3-tests/work/
export ROOTDIR=/scratch2/COASTAL/coastal/noscrub/shared/Saeed.Moghimi/coastalapp_test/rerun-andre/CoastalApp/
#export ROOTDIR='/scratch2/COASTAL/coastal/save/Saeed.Moghimi/models/NEMS/tests/CoastalApp_test/temp7/CoastalApp/'
#export ROOTDIR=/scratch2/COASTAL/coastal/noscrub/shared/Saeed.Moghimi/coastalapp_test/temp7/CoastalApp.ali.matis/
#export ROOTDIR=/scratch2/COASTAL/coastal/noscrub/shared/Saeed.Moghimi/coastalapp_test/temp7/CoastalApp.takis
#export ROOTDIR=/scratch2/COASTAL/coastal/noscrub/shared/Saeed.Moghimi/coastalapp_test/temp7/CoastalApp
#export ROOTDIR=/scratch2/COASTAL/coastal/save/Andre.VanderWesthuysen/OCS-NEMS-PAHM/CoastalApp

export EXECnsem=${ROOTDIR}/ALLBIN_INSTALL/

#source ${ROOTDIR}/modulefiles/hera/ESMF_NUOPC
source ${ROOTDIR}/modulefiles/envmodules_intel.hera
#source /scratch2/COASTAL/coastal/save/Andre.VanderWesthuysen/ADC-WW3-NWM-NEMS/modulefiles/hera/ESMF_NUOPC
#module load intel/19.0.5.281
#module load wgrib2/2.0.8
#module load nco/4.9.1

module list

ulimit -s unlimited
ulimit -c 0

export OMP_NUM_THREADS=1
export KMP_AFFINITY=disabled
export KMP_STACKSIZE=2G
export IOBUF_PARAMS='*:size=1M:count=4:vbuffer_count=4096:prefetch=1'

export model="nsem"
export MODEL=${model^^}

export envir="para"

export DEVWCOSS_USER=$(whoami)
export COMROOT=/scratch2/COASTAL/coastal/save/com

#Dev environment value for $job and $jobid
export job=pnsem_forecast
export jobid=pnsem_forecast.$$

#Dev environment jlogfile
#mkdir -p ${COMROOT}/logs/${envir}
#export jlogfile=${COMROOT}/logs/${envir}/jlogfile.${job}



./run_all.sh

# Get memory usage report
# NOTE: To do this interactively on the comaand line, use $report-mem -j $jobid
report-mem

#%manual
################################################################################
#TASKSCRIPT DOCUMENTATION BLOCK
#TASKSCRIPT:     jnsem_forecast
#LAST MODIFIER:  Andre van der Westhuysen
#ORGANIZATION:   IMSG at NOAA/NCEP/EMC
#DATE:           May 2020
#FULL NAME:      /nsem/jnsem
#PURPOSE:        To execute the forecast job for ADC-WW3-NWM model
#JOB SCRIPT CALLED: ${NWROOT}/jobs/JNSEM ==>
#                            ${NWROOT}/scripts/exnsem_forecast.sh.ecf
#################################################################################
######################################################################
# Job specific troubleshooting instructions:
#  see generic troubleshoot manual page
#
######################################################################
#%end
